module.exports=[66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},20635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},61724,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";e.s(["default",()=>r]);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["warn","error"]})},58845,e=>{"use strict";e.s(["applyEntitlementsForSubscription",()=>n,"decrementQuota",()=>o,"getOrCreateQuota",()=>i,"isWatermarkExempt",()=>s,"monthUtc",()=>a]);var t=e.i(15270);let r={FREE:{monthlyQuota:5,watermarkExempt:!1},BASIC_50:{monthlyQuota:50,watermarkExempt:!0},PLUS_200:{monthlyQuota:200,watermarkExempt:!0},PRO_1000:{monthlyQuota:1e3,watermarkExempt:!0}};function a(e=new Date){let t=e.getUTCFullYear(),r=(e.getUTCMonth()+1).toString().padStart(2,"0");return`${t}-${r}`}async function i(e,n=a()){let o=await t.default.quota.findUnique({where:{userId_monthUtc:{userId:e,monthUtc:n}}});return o||(o=await t.default.quota.create({data:{userId:e,monthUtc:n,freeRemaining:r.FREE.monthlyQuota,paidRemaining:0,watermarkExempt:!1}})),o}async function n(e){let{userId:n,status:o,stripeCustomerId:s,stripeSubscriptionId:d,stripePriceId:p,currentPeriodStart:u,currentPeriodEnd:x,anchorUtcDay:l}=e,c="active"===o||"trialing"===o?function(e){let t=process.env.PRICE_ID_BASIC_50,r=process.env.PRICE_ID_PLUS_200,a=process.env.PRICE_ID_PRO_1000;return e&&t&&e===t?"BASIC_50":e&&r&&e===r?"PLUS_200":e&&a&&e===a?"PRO_1000":"FREE"}(p):"FREE";await t.default.subscription.upsert({where:{stripeSubscriptionId:d??""},update:{userId:n,status:o,planTier:c,stripeCustomerId:s??void 0,stripePriceId:p??void 0,currentPeriodStart:u??void 0,currentPeriodEnd:x??void 0,anchorUtcDay:l??void 0},create:{userId:n,status:o,planTier:c,stripeCustomerId:s??void 0,stripeSubscriptionId:d??void 0,stripePriceId:p??void 0,currentPeriodStart:u??void 0,currentPeriodEnd:x??void 0,anchorUtcDay:l??void 0}});let m=a(),f=await i(n,m);if("FREE"===c){let e=r.FREE.monthlyQuota;await t.default.quota.update({where:{id:f.id},data:{freeRemaining:Math.min(f.freeRemaining??0,e),paidRemaining:0,watermarkExempt:!1}})}else{let{monthlyQuota:e,watermarkExempt:a}=r[c];await t.default.quota.update({where:{id:f.id},data:{paidRemaining:e,watermarkExempt:a}})}return await t.default.auditLog.create({data:{userId:n,action:"ENTITLEMENTS_SYNC",contextJson:{status:o,stripeCustomerId:s,stripeSubscriptionId:d,stripePriceId:p,resolvedTier:c,month:m}}}),{tier:c}}async function o(e){let r=a(),n=await i(e,r);if(n.paidRemaining>0)return t.default.quota.update({where:{id:n.id},data:{paidRemaining:{decrement:1}}});if(n.freeRemaining>0)return t.default.quota.update({where:{id:n.id},data:{freeRemaining:{decrement:1}}});throw Error("Quota exceeded for the current month")}async function s(e){let r=await t.default.quota.findFirst({where:{userId:e,monthUtc:a()},select:{watermarkExempt:!0}});return r?.watermarkExempt??!1}},71815,(e,t,r)=>{t.exports=e.x("sharp",()=>require("sharp"))},86500,(e,t,r)=>{}];

//# sourceMappingURL=%5Broot-of-the-server%5D__cf0924da._.js.map