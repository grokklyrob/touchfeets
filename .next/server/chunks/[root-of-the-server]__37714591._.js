module.exports=[24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},20635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},61724,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";e.s(["default",()=>r]);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["warn","error"]})},58845,e=>{"use strict";e.s(["applyEntitlementsForSubscription",()=>i,"decrementQuota",()=>o,"getOrCreateQuota",()=>n,"isWatermarkExempt",()=>s,"monthUtc",()=>a]);var t=e.i(15270);let r={FREE:{monthlyQuota:5,watermarkExempt:!1},BASIC_50:{monthlyQuota:50,watermarkExempt:!0},PLUS_200:{monthlyQuota:200,watermarkExempt:!0},PRO_1000:{monthlyQuota:1e3,watermarkExempt:!0}};function a(e=new Date){let t=e.getUTCFullYear(),r=(e.getUTCMonth()+1).toString().padStart(2,"0");return`${t}-${r}`}async function n(e,i=a()){let o=await t.default.quota.findUnique({where:{userId_monthUtc:{userId:e,monthUtc:i}}});return o||(o=await t.default.quota.create({data:{userId:e,monthUtc:i,freeRemaining:r.FREE.monthlyQuota,paidRemaining:0,watermarkExempt:!1}})),o}async function i(e){let{userId:i,status:o,stripeCustomerId:s,stripeSubscriptionId:l,stripePriceId:u,currentPeriodStart:d,currentPeriodEnd:p,anchorUtcDay:c}=e,f="active"===o||"trialing"===o?function(e){let t=process.env.PRICE_ID_BASIC_50,r=process.env.PRICE_ID_PLUS_200,a=process.env.PRICE_ID_PRO_1000;return e&&t&&e===t?"BASIC_50":e&&r&&e===r?"PLUS_200":e&&a&&e===a?"PRO_1000":"FREE"}(u):"FREE";await t.default.subscription.upsert({where:{stripeSubscriptionId:l??""},update:{userId:i,status:o,planTier:f,stripeCustomerId:s??void 0,stripePriceId:u??void 0,currentPeriodStart:d??void 0,currentPeriodEnd:p??void 0,anchorUtcDay:c??void 0},create:{userId:i,status:o,planTier:f,stripeCustomerId:s??void 0,stripeSubscriptionId:l??void 0,stripePriceId:u??void 0,currentPeriodStart:d??void 0,currentPeriodEnd:p??void 0,anchorUtcDay:c??void 0}});let m=a(),h=await n(i,m);if("FREE"===f){let e=r.FREE.monthlyQuota;await t.default.quota.update({where:{id:h.id},data:{freeRemaining:Math.min(h.freeRemaining??0,e),paidRemaining:0,watermarkExempt:!1}})}else{let{monthlyQuota:e,watermarkExempt:a}=r[f];await t.default.quota.update({where:{id:h.id},data:{paidRemaining:e,watermarkExempt:a}})}return await t.default.auditLog.create({data:{userId:i,action:"ENTITLEMENTS_SYNC",contextJson:{status:o,stripeCustomerId:s,stripeSubscriptionId:l,stripePriceId:u,resolvedTier:f,month:m}}}),{tier:f}}async function o(e){let r=a(),i=await n(e,r);if(i.paidRemaining>0)return t.default.quota.update({where:{id:i.id},data:{paidRemaining:{decrement:1}}});if(i.freeRemaining>0)return t.default.quota.update({where:{id:i.id},data:{freeRemaining:{decrement:1}}});throw Error("Quota exceeded for the current month")}async function s(e){let r=await t.default.quota.findFirst({where:{userId:e,monthUtc:a()},select:{watermarkExempt:!0}});return r?.watermarkExempt??!1}},71815,(e,t,r)=>{t.exports=e.x("sharp",()=>require("sharp"))},47829,(e,t,r)=>{},82344,e=>{"use strict";e.s(["handler",()=>T,"patchFetch",()=>I,"routeModule",()=>A,"serverHooks",()=>N,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>_],82344);var t=e.i(47909),r=e.i(74017),a=e.i(96250),n=e.i(59756),i=e.i(61916),o=e.i(69741),s=e.i(16795),l=e.i(87718),u=e.i(95169),d=e.i(47587),p=e.i(66012),c=e.i(70101),f=e.i(26937),m=e.i(10372),h=e.i(93695);e.i(52474);var x=e.i(220);e.s(["GET",()=>P,"dynamic",()=>q,"runtime",()=>b],13885);var g=e.i(89171),w=e.i(23667),R=e.i(77087),v=e.i(15270),E=e.i(58845),y=e.i(71815);async function C(e,t){let r=t?.text??"touchfeets.com",a=Math.min(1,Math.max(0,t?.opacity??.55)),n=t?.marginPct??.05,i=t?.fontSizePct??.045,o=t?.fill??"#ffffff",s=Buffer.isBuffer(e)?e:Buffer.from(e),l=(0,y.default)(s),u=await l.metadata(),d=u.width??1024,p=u.height??1024,c=Math.max(16,Math.round(d*i)),f=Math.max(8,Math.round(p*n)),m=`
<svg width="${d}" height="${p}" viewBox="0 0 ${d} ${p}" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="glow">
      <feGaussianBlur stdDeviation="${Math.max(.6,.07*c)}" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
  <g opacity="${a}">
    <text x="${d/2}" y="${p-f}" text-anchor="middle"
          font-family="Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif"
          font-size="${c}" fill="${o}" filter="url(#glow)">${r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}</text>
  </g>
</svg>`.trim(),h=(u.format??"png").toLowerCase();return await l.composite([{input:Buffer.from(m),top:0,left:0}]).toFormat(h).toBuffer()}let b="nodejs",q="force-dynamic";async function P(e,t){let r=await (0,w.getServerSession)(R.authConfig),a=r?.user;if(!a?.id)return g.NextResponse.json({error:"Unauthorized"},{status:401});let n=a.id,i=await t.params,o=i?.id;if(!o)return g.NextResponse.json({error:"Missing job id"},{status:400});let s=await v.default.imageJob.findUnique({where:{id:o},select:{id:!0,userId:!0,status:!0,outputBlobUrl:!0,createdAt:!0,completedAt:!0}});if(!s)return g.NextResponse.json({error:"Not found"},{status:404});if(s.userId!==n)return g.NextResponse.json({error:"Forbidden"},{status:403});if(!s.outputBlobUrl||"COMPLETED"!==s.status)return g.NextResponse.json({error:"Not ready"},{status:409});let l="image/png";try{let e=(await fetch(s.outputBlobUrl,{method:"HEAD"})).headers.get("content-type");e&&(l=e)}catch{}let u=await fetch(s.outputBlobUrl);if(!u.ok)return g.NextResponse.json({error:"Failed to fetch output image"},{status:502});let d=await u.arrayBuffer(),p=d;if(!await (0,E.isWatermarkExempt)(n)){let e=await C(new Uint8Array(d),{text:"touchfeets.com",opacity:.55,marginPct:.05,fontSizePct:.045,fill:"#ffffff"}),t=new Uint8Array(e.byteLength);t.set(e),p=t.buffer}let c=`touchfeets-${s.id}.${function(e){let t=(e||"").toLowerCase();return t.includes("jpeg")?"jpg":t.includes("png")?"png":t.includes("webp")?"webp":t.includes("heic")?"heic":t.includes("heif")?"heif":"png"}(l)}`;return new Response(p,{status:200,headers:{"content-type":l,"content-disposition":`inline; filename="${c}"`,"cache-control":"private, max-age=0, no-store"}})}var S=e.i(13885);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/download/[id]/route",pathname:"/api/download/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/download/[id]/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:U,workUnitAsyncStorage:_,serverHooks:N}=A;function I(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:_})}async function T(e,t,a){var g;let w="/api/download/[id]/route";w=w.replace(/\/index$/,"")||"/";let R=await A.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:y,isDraftMode:C,prerenderManifest:b,routerServerContext:q,isOnDemandRevalidate:P,revalidateOnlyGenerated:S,resolvedPathname:U}=R,_=(0,o.normalizeAppPath)(w),N=!!(b.dynamicRoutes[_]||b.routes[U]);if(N&&!C){let e=!!b.routes[U],t=b.dynamicRoutes[_];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let I=null;!N||A.isDev||C||(I="/index"===(I=U)?"/":I);let T=!0===A.isDev||!N,k=N&&!T,j=e.method||"GET",M=(0,i.getTracer)(),O=M.getActiveScopeSpan(),$={params:E,prerenderManifest:b,renderOpts:{experimental:{cacheComponents:!!y.experimental.cacheComponents,authInterrupts:!!y.experimental.authInterrupts},supportsDynamicResponse:T,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(g=y.experimental)?void 0:g.cacheLife,isRevalidate:k,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,q)},sharedContext:{buildId:v}},D=new s.NodeNextRequest(e),B=new s.NodeNextResponse(t),F=l.NextRequestAdapter.fromNodeNextRequest(D,(0,l.signalFromNodeResponse)(t));try{let o=async r=>A.handle(F,$).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let e=`${j} ${n}`;r.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),r.updateName(e)}else r.updateName(`${j} ${e.url}`)}),s=async i=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&P&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=$.renderOpts.collectedTags;if(!N)return await (0,p.sendResponse)(D,B,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,c.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:k,isOnDemandRevalidate:P})},q),t}},h=await A.handleResponse({req:e,nextConfig:y,cacheKey:I,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:S,responseGenerator:u,waitUntil:a.waitUntil});if(!N)return null;if((null==h||null==(s=h.value)?void 0:s.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",P?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,c.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&N||g.delete(m.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,f.getCacheControlHeader)(h.cacheControl)),await (0,p.sendResponse)(D,B,new Response(h.value.body,{headers:g,status:h.value.status||200})),null};O?await s(O):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${e.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},s))}catch(t){if(O||t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:k,isOnDemandRevalidate:P})}),N)throw t;return await (0,p.sendResponse)(D,B,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__37714591._.js.map