module.exports=[24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},20635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},61724,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";e.s(["default",()=>r]);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["warn","error"]})},58845,e=>{"use strict";e.s(["applyEntitlementsForSubscription",()=>i,"decrementQuota",()=>s,"getOrCreateQuota",()=>n,"isWatermarkExempt",()=>o,"monthUtc",()=>a]);var t=e.i(15270);let r={FREE:{monthlyQuota:5,watermarkExempt:!1},BASIC_50:{monthlyQuota:50,watermarkExempt:!0},PLUS_200:{monthlyQuota:200,watermarkExempt:!0},PRO_1000:{monthlyQuota:1e3,watermarkExempt:!0}};function a(e=new Date){let t=e.getUTCFullYear(),r=(e.getUTCMonth()+1).toString().padStart(2,"0");return`${t}-${r}`}async function n(e,i=a()){let s=await t.default.quota.findUnique({where:{userId_monthUtc:{userId:e,monthUtc:i}}});return s||(s=await t.default.quota.create({data:{userId:e,monthUtc:i,freeRemaining:r.FREE.monthlyQuota,paidRemaining:0,watermarkExempt:!1}})),s}async function i(e){let{userId:i,status:s,stripeCustomerId:o,stripeSubscriptionId:d,stripePriceId:u,currentPeriodStart:p,currentPeriodEnd:c,anchorUtcDay:l}=e,m="active"===s||"trialing"===s?function(e){let t=process.env.PRICE_ID_BASIC_50,r=process.env.PRICE_ID_PLUS_200,a=process.env.PRICE_ID_PRO_1000;return e&&t&&e===t?"BASIC_50":e&&r&&e===r?"PLUS_200":e&&a&&e===a?"PRO_1000":"FREE"}(u):"FREE";await t.default.subscription.upsert({where:{stripeSubscriptionId:d??""},update:{userId:i,status:s,planTier:m,stripeCustomerId:o??void 0,stripePriceId:u??void 0,currentPeriodStart:p??void 0,currentPeriodEnd:c??void 0,anchorUtcDay:l??void 0},create:{userId:i,status:s,planTier:m,stripeCustomerId:o??void 0,stripeSubscriptionId:d??void 0,stripePriceId:u??void 0,currentPeriodStart:p??void 0,currentPeriodEnd:c??void 0,anchorUtcDay:l??void 0}});let h=a(),x=await n(i,h);if("FREE"===m){let e=r.FREE.monthlyQuota;await t.default.quota.update({where:{id:x.id},data:{freeRemaining:Math.min(x.freeRemaining??0,e),paidRemaining:0,watermarkExempt:!1}})}else{let{monthlyQuota:e,watermarkExempt:a}=r[m];await t.default.quota.update({where:{id:x.id},data:{paidRemaining:e,watermarkExempt:a}})}return await t.default.auditLog.create({data:{userId:i,action:"ENTITLEMENTS_SYNC",contextJson:{status:s,stripeCustomerId:o,stripeSubscriptionId:d,stripePriceId:u,resolvedTier:m,month:h}}}),{tier:m}}async function s(e){let r=a(),i=await n(e,r);if(i.paidRemaining>0)return t.default.quota.update({where:{id:i.id},data:{paidRemaining:{decrement:1}}});if(i.freeRemaining>0)return t.default.quota.update({where:{id:i.id},data:{freeRemaining:{decrement:1}}});throw Error("Quota exceeded for the current month")}async function o(e){let r=await t.default.quota.findFirst({where:{userId:e,monthUtc:a()},select:{watermarkExempt:!0}});return r?.watermarkExempt??!1}},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},76403,(e,t,r)=>{},44155,e=>{"use strict";e.s(["handler",()=>O,"patchFetch",()=>j,"routeModule",()=>U,"serverHooks",()=>N,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>A],44155);var t=e.i(47909),r=e.i(74017),a=e.i(96250),n=e.i(59756),i=e.i(61916),s=e.i(69741),o=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),c=e.i(66012),l=e.i(70101),m=e.i(26937),h=e.i(10372),x=e.i(93695);e.i(52474);var w=e.i(220);e.s(["POST",()=>k,"dynamic",()=>b,"runtime",()=>g],23976);var E=e.i(89171),f=e.i(22880),R=e.i(15270),v=e.i(58845),y=e.i(63955);let g="nodejs",b="force-dynamic",I=new f.default(process.env.STRIPE_SECRET_KEY??"");async function _(e){try{return await R.default.webhookEvent.create({data:{type:e.type,stripeEventId:e.id,payloadJson:e,status:"received"}}),!0}catch{return!1}}async function C(e,t){try{await R.default.webhookEvent.update({where:{stripeEventId:e},data:{status:t,processedAt:new Date}})}catch{}}async function P(e){let t=await I.subscriptions.retrieve(e),r=t.items.data[0]?.price?.id??null;return{status:t.status,stripeCustomerId:"string"==typeof t.customer?t.customer:t.customer?.id??null,stripeSubscriptionId:t.id,stripePriceId:r,currentPeriodStart:t.current_period_start?new Date(1e3*t.current_period_start):null,currentPeriodEnd:t.current_period_end?new Date(1e3*t.current_period_end):null,anchorUtcDay:1}}async function S(e){if(!e)return null;let t=await R.default.subscription.findFirst({where:{stripeCustomerId:e},select:{userId:!0}});return t?.userId??null}async function k(e){let t,r=e.headers.get("stripe-signature");if(!r)return E.NextResponse.json({error:"Missing Stripe-Signature header"},{status:400});let a=process.env.STRIPE_WEBHOOK_SECRET;if(!a)return E.NextResponse.json({error:"Missing STRIPE_WEBHOOK_SECRET"},{status:500});try{let n=await e.text();t=I.webhooks.constructEvent(n,r,a)}catch(e){return E.NextResponse.json({error:`Invalid webhook: ${e instanceof Error?e.message:"Unknown error"}`},{status:400})}if(!await (0,y.tryAcquireIdempotency)((0,y.stripeEventLockKey)(t.id)))return E.NextResponse.json({ok:!0,deduped:!0,via:"redis"});if(!await _(t))return E.NextResponse.json({ok:!0,deduped:!0});try{switch(t.type){case"checkout.session.completed":{let e=t.data.object,r="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(r){let e=await P(r),t=await S(e.stripeCustomerId);t&&await (0,v.applyEntitlementsForSubscription)({userId:t,status:e.status,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,stripePriceId:e.stripePriceId,currentPeriodStart:e.currentPeriodStart,currentPeriodEnd:e.currentPeriodEnd,anchorUtcDay:e.anchorUtcDay})}break}case"customer.subscription.updated":case"customer.subscription.deleted":{let e=t.data.object,r=e.items?.data?.[0]?.price?.id??null,a="string"==typeof e.customer?e.customer:e.customer?.id??null,n=await S(a);n&&await (0,v.applyEntitlementsForSubscription)({userId:n,status:e.status,stripeCustomerId:a,stripeSubscriptionId:e.id,stripePriceId:r,currentPeriodStart:e.current_period_start?new Date(1e3*e.current_period_start):null,currentPeriodEnd:e.current_period_end?new Date(1e3*e.current_period_end):null,anchorUtcDay:1});break}case"invoice.payment_failed":{let e=t.data.object,r="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(r){let e=await P(r),t=await S(e.stripeCustomerId);t&&await (0,v.applyEntitlementsForSubscription)({userId:t,status:"past_due",stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,stripePriceId:e.stripePriceId,currentPeriodStart:e.currentPeriodStart,currentPeriodEnd:e.currentPeriodEnd,anchorUtcDay:e.anchorUtcDay})}}}return await C(t.id,"processed"),E.NextResponse.json({ok:!0})}catch(e){return console.error("webhook processing error",e),await C(t.id,"failed"),E.NextResponse.json({error:e instanceof Error?e.message:"Webhook failed"},{status:500})}}var T=e.i(23976);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:q,workUnitAsyncStorage:A,serverHooks:N}=U;function j(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:A})}async function O(e,t,a){var E;let f="/api/stripe/webhook/route";f=f.replace(/\/index$/,"")||"/";let R=await U.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:y,nextConfig:g,isDraftMode:b,prerenderManifest:I,routerServerContext:_,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,resolvedPathname:S}=R,k=(0,s.normalizeAppPath)(f),T=!!(I.dynamicRoutes[k]||I.routes[S]);if(T&&!b){let e=!!I.routes[S],t=I.dynamicRoutes[k];if(t&&!1===t.fallback&&!e)throw new x.NoFallbackError}let q=null;!T||U.isDev||b||(q="/index"===(q=S)?"/":q);let A=!0===U.isDev||!T,N=T&&!A,j=e.method||"GET",O=(0,i.getTracer)(),D=O.getActiveScopeSpan(),F={params:y,prerenderManifest:I,renderOpts:{experimental:{cacheComponents:!!g.experimental.cacheComponents,authInterrupts:!!g.experimental.authInterrupts},supportsDynamicResponse:A,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(E=g.experimental)?void 0:E.cacheLife,isRevalidate:N,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>U.onRequestError(e,t,a,_)},sharedContext:{buildId:v}},H=new o.NodeNextRequest(e),M=new o.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(H,(0,d.signalFromNodeResponse)(t));try{let s=async r=>U.handle(K,F).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=O.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let e=`${j} ${n}`;r.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),r.updateName(e)}else r.updateName(`${j} ${e.url}`)}),o=async i=>{var o,d;let u=async({previousCacheEntry:r})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&C&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let u=F.renderOpts.collectedTags;if(!T)return await (0,c.sendResponse)(H,M,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,l.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isRevalidate:N,isOnDemandRevalidate:C})},_),t}},x=await U.handleResponse({req:e,nextConfig:g,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,responseGenerator:u,waitUntil:a.waitUntil});if(!T)return null;if((null==x||null==(o=x.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==x||null==(d=x.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",C?"REVALIDATED":x.isMiss?"MISS":x.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let E=(0,l.fromNodeOutgoingHttpHeaders)(x.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&T||E.delete(h.NEXT_CACHE_TAGS_HEADER),!x.cacheControl||t.getHeader("Cache-Control")||E.get("Cache-Control")||E.set("Cache-Control",(0,m.getCacheControlHeader)(x.cacheControl)),await (0,c.sendResponse)(H,M,new Response(x.value.body,{headers:E,status:x.value.status||200})),null};D?await o(D):await O.withPropagatedContext(e.headers,()=>O.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${e.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},o))}catch(t){if(D||t instanceof x.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isRevalidate:N,isOnDemandRevalidate:C})}),T)throw t;return await (0,c.sendResponse)(H,M,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e630a28c._.js.map